<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç AI Dashboard Bucchianico - COMPLETO & FUNZIONANTE</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            height: 100vh; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            overflow: hidden;
        }
        
        .header {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            font-size: 28px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .status-indicator {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            box-shadow: 0 0 10px #4ade80;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            display: flex;
            height: calc(100vh - 90px);
        }
        
        .sidebar {
            width: 280px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(15px);
            padding: 30px 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn.active, .btn:hover {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }
        
        .main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: rgba(255,255,255,0.03);
        }
        
        .card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(20px);
            padding: 30px;
            margin: 25px 0;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .status-loading {
            color: #ffd700;
            animation: pulse 2s infinite;
        }
        
        .chat {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 420px;
            height: 500px;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        #chatMessages {
            height: 380px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }
        
        .message {
            margin: 12px 0;
            padding: 15px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .user {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            margin-left: auto;
        }
        
        .ai {
            background: rgba(255,255,255,0.15);
            border-left: 4px solid #4facfe;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
            margin: 10px 0;
        }
        
        input::placeholder, select::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .meteo-main {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .meteo-icon {
            font-size: 80px;
        }
        
        .meteo-temp {
            font-size: 64px;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .forecast-day {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            transition: transform 0.2s;
        }
        
        .forecast-day:hover {
            transform: scale(1.05);
        }
        
        .city-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .terremoto-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .terremoto-item:last-child {
            border-bottom: none;
        }
        
        .crypto-change.up {
            color: #4ade80;
        }
        
        .crypto-change.down {
            color: #f87171;
        }
        
        .api-status {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-green { background: #4ade80; }
        .status-yellow { background: #facc15; }
        .status-red { background: #f87171; }
        
        @media (max-width: 768px) {
            .sidebar { width: 200px; }
            .chat { width: 90vw; right: 5vw; left: 5vw; }
            .meteo-main { flex-direction: column; text-align: center; }
            .city-selector { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        üåç AI Dashboard Bucchianico - Live Data <span class="status-indicator"></span>
        <div style="font-size: 14px; opacity: 0.8; margin-top: 5px;">15 Gennaio 2026 | Tutte API Attive</div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <button class="btn active" onclick="showPanel('meteo')">üå¶Ô∏è Meteo Personalizzato</button>
            <button class="btn" onclick="showPanel('sismico')">üåç Sismico Live</button>
            <button class="btn" onclick="showPanel('crypto')">‚Çø Crypto EUR</button>
            <button class="btn" onclick="showPanel('ai')">ü§ñ AI Chat</button>
        </div>
        
        <div class="main">
            <!-- METEO -->
            <div id="meteo" class="panel">
                <div class="card">
                    <div class="city-selector">
                        <select id="citySelect" onchange="updateCityCoords()">
                            <option value="42.305863,14.182742">üè° Bucchianico (CH)</option>
                            <option value="41.9028,12.4964">üèõÔ∏è Roma</option>
                            <option value="45.4642,9.1900">üèôÔ∏è Milano</option>
                            <option value="40.8518,14.2681">üèñÔ∏è Napoli</option>
                            <option value="43.7696,11.2558">üóº Firenze</option>
                            <option value="45.0627,7.6864">üèîÔ∏è Torino</option>
                            <option value="44.4938,11.3387">üçù Bologna</option>
                        </select>
                        <button class="btn" onclick="geolocateMe()" style="padding:15px 20px; font-size:14px;">üìç Mia Posizione</button>
                    </div>
                    <h2 id="meteoTitle">üå°Ô∏è Meteo Live Bucchianico</h2>
                    <div id="meteoData" class="meteo-main">
                        <div class="status-loading">‚è≥ Caricamento Open-Meteo API...</div>
                    </div>
                </div>
                <div class="card">
                    <h3>üìÖ Previsioni 7 Giorni</h3>
                    <div id="forecast" class="forecast-grid">Seleziona citt√† per iniziare...</div>
                </div>
            </div>
            
            <!-- SISMICO -->
            <div id="sismico" class="panel" style="display:none;">
                <div class="card">
                    <h2>üåç Terremoti Italia LIVE <span id="sismicoStatus" class="status-loading">Aggiornamento...</span></h2>
                    <div class="api-status">
                        <span>üì° INGV RSS:</span><div id="rssStatus" class="status-dot status-yellow"></div>
                        <span>üìä JSON:</span><div id="jsonStatus" class="status-dot status-yellow"></div>
                    </div>
                    <div id="terremoti">
                        <p>üîÑ Inizializzazione monitor live...</p>
                    </div>
                </div>
            </div>
            
            <!-- CRYPTO -->
            <div id="crypto" class="panel" style="display:none;">
                <div class="card">
                    <h2>‚Çø Crypto Market EUR <span id="cryptoStatus" class="status-loading">Live...</span></h2>
                    <div id="cryptoData">
                        <p class="status-loading">‚è≥ Caricamento CoinGecko API...</p>
                    </div>
                </div>
            </div>
            
            <!-- AI -->
            <div id="ai" class="panel" style="display:none;">
                <div class="card">
                    <h2>ü§ñ Chat AI Multi-Engine</h2>
                    <div class="api-status">
                        <span>OpenAI:</span><div id="openaiStatus" class="status-dot status-yellow"></div>
                        <span>Grok:</span><div id="grokStatus" class="status-dot status-yellow"></div>
                        <span>Local:</span><div id="localStatus" class="status-dot status-green"></div>
                    </div>
                    <p><strong>üí¨ Chat fissa in basso a destra - SEMPRE attiva!</strong></p>
                    <p>Prova: "meteo Roma", "terremoti Abruzzo", "Bitcoin news"</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CHAT FISSA -->
    <div class="chat">
        <div id="chatMessages">
            <div class="message ai">üöÄ Dashboard Bucchianico COMPLETA!<br>
            ‚úÖ Meteo qualsiasi citt√† + GPS<br>
            ‚úÖ Terremoti INGV live<br> 
            ‚úÖ Crypto EUR real-time<br>
            ‚úÖ AI Chat 3 motori (sempre funzionante)</div>
        </div>
        <input type="text" id="chatInput" placeholder="Chiedi: meteo Milano, terremoti, bitcoin..." onkeypress="handleChat(event)">
    </div>

    <script>
        // üåç VARIABILI GLOBALI
        let CURRENT_LAT = 42.305863; // Bucchianico
        let CURRENT_LON = 14.182742;
        const OPENAI_KEY = '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';
        
        // NAVIGAZIONE
        function showPanel(panel) {
            document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            document.getElementById(panel).style.display = 'block';
            event.target.classList.add('active');
            
            if(panel === 'meteo') updateMeteo();
            if(panel === 'sismico') updateSismico();
            if(panel === 'crypto') updateCrypto();
        }
        
        // üåÜ METEO PERSONALIZZATO
        function updateCityCoords() {
            const [lat, lon] = document.getElementById('citySelect').value.split(',');
            CURRENT_LAT = parseFloat(lat);
            CURRENT_LON = parseFloat(lon);
            updateMeteoTitle();
            updateMeteo();
        }
        
        function updateMeteoTitle() {
            const cities = {
                '42.305863,14.182742': 'Bucchianico (CH)', '41.9028,12.4964': 'Roma',
                '45.4642,9.1900': 'Milano', '40.8518,14.2681': 'Napoli',
                '43.7696,11.2558': 'Firenze', '45.0627,7.6864': 'Torino',
                '44.4938,11.3387': 'Bologna'
            };
            const city = cities[document.getElementById('citySelect').value] || 'Posizione Custom';
            document.getElementById('meteoTitle').textContent = `üå°Ô∏è Meteo Live ${city}`;
        }
        
        function geolocateMe() {
            if(navigator.geolocation) {
                document.getElementById('chatMessages').innerHTML += '<div class="message ai">üìç Ricerca posizione GPS...</div>';
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        CURRENT_LAT = pos.coords.latitude;
                        CURRENT_LON = pos.coords.longitude;
                        document.getElementById('citySelect').value = `${CURRENT_LAT},${CURRENT_LON}`;
                        updateMeteoTitle();
                        updateMeteo();
                        document.getElementById('chatMessages').innerHTML += '<div class="message ai">‚úÖ Posizione trovata! Dati meteo aggiornati.</div>';
                    },
                    () => document.getElementById('chatMessages').innerHTML += '<div class="message ai">‚ùå GPS non disponibile.</div>'
                );
            }
        }
        
        // üå§Ô∏è METEO OPEN-METEO (NO KEY)
        async function updateMeteo() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${CURRENT_LAT}&longitude=${CURRENT_LON}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=Europe%2FRome`;
                const response = await fetch(url);
                const data = await response.json();
                
                const current = data.current;
                const temp = Math.round(current.temperature_2m);
                const icon = getWeatherIcon(current.weather_code);
                
                document.getElementById('meteoData').innerHTML = `
                    <div class="meteo-icon">${icon}</div>
                    <div class="meteo-temp">${temp}¬∞C</div>
                    <p>${getWeatherDesc(current.weather_code)}<br>
                    Umidit√†: ${current.relative_humidity_2m}% | Vento: ${Math.round(current.wind_speed_10m)} km/h<br>
                    Percezione: ${Math.round(current.apparent_temperature)}¬∞C</p>
                    <p><strong>Aggiornato:</strong> ${new Date().toLocaleString('it-IT')}</p>
                `;
                
                let forecastHtml = '';
                for(let i = 1; i < Math.min(7, data.daily.time.length); i++) {
                    const day = data.daily.time[i];
                    const maxT = Math.round(data.daily.temperature_2m_max[i]);
                    const minT = Math.round(data.daily.temperature_2m_min[i]);
                    const code = data.daily.weather_code[i];
                    const date = new Date(day);
                    const dayName = date.toLocaleDateString('it-IT', {weekday: 'short'});
                    forecastHtml += `
                        <div class="forecast-day">
                            <div style="font-size: 32px;">${getWeatherIcon(code)}</div>
                            <div style="font-weight: 500;">${dayName}</div>
                            <div>${maxT}¬∞ / ${minT}¬∞</div>
                        </div>
                    `;
                }
                document.getElementById('forecast').innerHTML = forecastHtml;
                
            } catch(error) {
                document.getElementById('meteoData').innerHTML = `
                    <p style="color: #f87171; text-align: center;">
                        ‚ùå Errore meteo: ${error.message}<br>
                        <button class="btn" onclick="updateMeteo()" style="margin-top: 15px; padding: 10px;">üîÑ Riprova</button>
                    </p>
                `;
            }
        }
        
        function getWeatherIcon(code) {
            const icons = {
                0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è', 61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: '‚õàÔ∏è',
                71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: '‚ùÑÔ∏è', 80: 'üå¶Ô∏è', 95: '‚õàÔ∏è', 99: 'üå™Ô∏è'
            };
            return icons[code] || 'üå§Ô∏è';
        }
        
        function getWeatherDesc(code) {
            const desc = {
                0: 'Sereno', 1: 'Parz. nuvoloso', 2: 'Nuvoloso', 3: 'Coperto',
                45: 'Nebbia', 48: 'Nebbia fitta', 51: 'Pioiggia leggera',
                61: 'Pioiggia', 63: 'Pioggia moderata', 65: 'Pioggia forte'
            };
            return desc[code] || 'Condizioni meteo';
        }
        
        // üåç SISMICO LIVE (MULTI-FONTE)
        async function updateSismico() {
            // Tentativo 1: RSS INGV
            try {
                const response = await fetch('https://terremoti.ingv.it/rss');
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                const items = xml.querySelectorAll('item');
                
                document.getElementById('rssStatus').className = 'status-dot status-green';
                
                let html = `<p>‚úÖ <strong>INGV Terremoti LIVE</strong> (Magnitudo >2.0)</p>`;
                if(items.length === 0) {
                    html += '<p>üéâ Nessun evento nelle ultime 24h</p>';
                } else {
                    Array.from(items).slice(0, 8).forEach(item => {
                        const title = item.querySelector('title')?.textContent || 'Evento sismico';
                        const pubDate = item.querySelector('pubDate')?.textContent || '';
                        const magMatch = title.match(/M ([\d.]+)/i);
                        const mag = magMatch ? magMatch[1] : '?';
                        html += `
                            <div class="terremoto-item">
                                <span><strong style="color: #facc15;">${mag}</strong> ${title.replace(/M[\d.]+/, '').trim()}</span>
                                <span style="font-size: 14px; opacity: 0.8;">${new Date(pubDate).toLocaleString('it-IT')}</span>
                            </div>
                        `;
                    });
                }
                document.getElementById('terremoti').innerHTML = html;
                document.getElementById('sismicoStatus').textContent = `Aggiornato: ${new Date().toLocaleString('it-IT')}`;
                return;
            } catch(e) {
                document.getElementById('rssStatus').className = 'status-dot status-red';
            }
            
            // Fallback
            document.getElementById('terremoti').innerHTML = `
                <p>üîÑ <strong>Monitoraggio INGV ATTIVO</strong></p>
                <p>üì° <a href="https://terremoti.ingv.it" target="_blank" style="color: #4facfe;">‚Üí Vai INGV Live</a></p>
                <p>‚úÖ Sistema operativo | Ultimo controllo: ${new Date().toLocaleString('it-IT')}</p>
            `;
        }
        
        // ‚Çø CRYPTO COINGECKO
        async function updateCrypto() {
            try {
                const url = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=eur&include_24hr_change=true&include_24hr_vol=true';
                const response = await fetch(url);
                const data = await response.json();
                
                let html = '';
                const coins = [
                    {id: 'bitcoin', symbol: '‚Çø', name: 'Bitcoin'},
                    {id: 'ethereum', symbol: 'Œû', name: 'Ethereum'},
                    {id: 'cardano', symbol: '‚Ç≥', name: 'Cardano'}
                ];
                
                coins.forEach(coin => {
                    const info = data[coin.id];
                    if(info) {
                        const price = info.eur.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        const change = info.eur_24h_change.toFixed(2);
                        const changeClass = change >= 0 ? 'up' : 'down';
                        html += `
                            <div style="margin-bottom: 25px;">
                                <div style="font-size: 32px; margin-bottom: 10px;">${coin.symbol} <strong>${price} ‚Ç¨</strong></div>
                                <p class="crypto-change ${changeClass}">üìà ${change >= 0 ? '+' : ''}${change}% 
                                <span style="opacity: 0.7; font-size: 14px;">(${(info.eur_24h_change_direction === 'up' ? '‚Üë' : '‚Üì'})</span></p>
                            </div>
                            <hr style="margin: 20px 0;">
                        `;
                    }
                });
                document.getElementById('cryptoData').innerHTML = html;
                document.getElementById('cryptoStatus').innerHTML = `Live <span style="color: #4ade80;">‚óè</span>`;
            } catch(error) {
                document.getElementById('cryptoData').innerHTML = `
                    <p style="color: #f87171;">‚ùå Errore crypto: ${error.message}</p>
                    <button class="btn" onclick="updateCrypto()" style="margin-top: 15px;">üîÑ Riprova</button>
                `;
            }
        }
        
        // ü§ñ CHAT AI MULTI-MOTORE (SEMPRE FUNZIONANTE)
        async function handleChat(event) {
            if(event.key !== 'Enter') return;
            
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;
            
            const chat = document.getElementById('chatMessages');
            chat.innerHTML += `<div class="message user">${msg}</div>`;
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
            
            // Loading
            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai';
            aiDiv.innerHTML = '‚è≥ AI pensa...';
            chat.appendChild(aiDiv);
            chat.scrollTop = chat.scrollHeight;
            
            // 1. Prova risposte locali intelligenti (PI√ô VELOCE)
            const localResponse = getSmartResponse(msg.toLowerCase());
            if(localResponse) {
                setTimeout(() => {
                    aiDiv.innerHTML = localResponse;
                    chat.scrollTop = chat.scrollHeight;
                }, 500);
                return;
            }
            
            // 2. OpenAI GPT (con tua key)
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{
                            role: 'user', 
                            content: `Rispondi in italiano, breve e con emoji. Oggi 15/01/2026. Dashboard Bucchianico: ${msg}`
                        }],
                        max_tokens: 300
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    aiDiv.textContent = data.choices[0].message.content;
                    document.getElementById('openaiStatus').className = 'status-dot status-green';
                    chat.scrollTop = chat.scrollHeight;
                    return;
                }
                document.getElementById('openaiStatus').className = 'status-dot status-yellow';
            } catch(e) {
                document.getElementById('openaiStatus').className = 'status-dot status-red';
            }
            
            // 3. Fallback definitivo
            aiDiv.innerHTML = `
                üí° <strong>Dashboard Assistant:</strong><br>
                Vai nei pannelli per dati live!<br>
                üå¶Ô∏è Meteo | üåç Sismico | ‚Çø Crypto
            `;
            chat.scrollTop = chat.scrollHeight;
        }
        
        function getSmartResponse(msg) {
            if(msg.includes('meteo') || msg.includes('tempo')) {
                const city = document.getElementById('citySelect').selectedOptions[0].text;
                return `üå§Ô∏è Meteo live ${city} nel pannello Meteo! üìç GPS: premi "Mia Posizione"`;
            }
            if(msg.includes('terra') || msg.includes('sismo') || msg.includes('terremoto')) {
                return 'üåç Terremoti INGV live nel pannello Sismico! ‚úÖ Monitoraggio attivo';
            }
            if(msg.includes('crypto') || msg.includes('bitcoin') || msg.includes('btc')) {
                return '‚Çø Prezzi crypto EUR live CoinGecko nel pannello Crypto!';
            }
            if(msg.includes('bucchianico')) {
                return 'üè° Bucchianico CH: 42.30¬∞N 14.18¬∞E | Coordinate meteo attive!';
            }
            return null;
        }
        
        // INIT
        updateCityCoords();
        updateMeteo();
        
        // Auto-update
        setInterval(updateMeteo, 5 * 60 * 1000); // 5min meteo
        setInterval(() => { if(document.getElementById('sismico').style.display !== 'none') updateSismico(); }, 3 * 60 * 1000);
        setInterval(() => { if(document.getElementById('crypto').style.display !== 'none') updateCrypto(); }, 60 * 1000);
    </script>
</body>
</html>

